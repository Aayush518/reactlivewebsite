"use strict";var e=require("@babel/runtime/helpers/extends"),r=require("three"),t=require("react"),i=require("@react-three/fiber"),o=require("./AxisArrow.cjs.js"),n=require("./PlaneSlider.cjs.js"),a=require("./AxisRotator.cjs.js"),c=require("./context.cjs.js");function s(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var i=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,i.get?i:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}require("../../core/Line.cjs.js"),require("three-stdlib"),require("../Html.cjs.js"),require("react-dom/client"),require("lodash.clamp");var l=s(r),u=s(t);const d=new l.Vector3,x=new l.Vector3,m=new l.Vector3,p=(e,r,t,i=1)=>{const o=d.set(e.x/t.width*2-1,-e.y/t.height*2+1,i);return o.unproject(r),o},f=(e,r,t,i)=>{const o=((e,r,t)=>{const i=t.width/2,o=t.height/2;r.updateMatrixWorld(!1);const n=e.project(r);return n.x=n.x*i+i,n.y=-n.y*o+o,n})(m.copy(e),t,i);let n=0;for(let a=0;a<2;++a){const c=x.copy(o).setComponent(a,o.getComponent(a)+r),s=p(c,t,i,c.z);n=Math.max(n,e.distanceTo(s))}return n},y=new l.Matrix4,w=new l.Matrix4,g=new l.Matrix4,v=new l.Matrix4,h=new l.Matrix4,E=new l.Matrix4,j=new l.Matrix4,b=new l.Matrix4,A=new l.Box3,M=new l.Box3,q=new l.Vector3,V=new l.Vector3,R=new l.Vector3,S=new l.Vector3,C=new l.Vector3(1,0,0),D=new l.Vector3(0,1,0),P=new l.Vector3(0,0,1),W=u.forwardRef((({matrix:r,onDragStart:t,onDrag:s,onDragEnd:d,autoTransform:x=!0,anchor:m,disableAxes:p=!1,disableSliders:W=!1,disableRotations:L=!1,activeAxes:B=[!0,!0,!0],offset:O=[0,0,0],rotation:T=[0,0,0],scale:z=1,lineWidth:k=4,fixed:F=!1,translationLimits:H,rotationLimits:I,depthTest:U=!0,axisColors:G=["#ff2060","#20df80","#2080ff"],hoveredColor:J="#ffff40",annotations:K=!1,annotationsClass:N,opacity:Q=1,visible:X=!0,userData:Y,children:Z,...$},_)=>{const ee=i.useThree((e=>e.invalidate)),re=u.useRef(null),te=u.useRef(null),ie=u.useRef(null),oe=u.useRef(null),ne=u.useRef([0,0,0]);u.useLayoutEffect((()=>{m&&(oe.current.updateWorldMatrix(!0,!0),v.copy(oe.current.matrixWorld).invert(),A.makeEmpty(),oe.current.traverse((e=>{e.geometry&&(e.geometry.boundingBox||e.geometry.computeBoundingBox(),E.copy(e.matrixWorld).premultiply(v),M.copy(e.geometry.boundingBox),M.applyMatrix4(E),A.union(M))})),q.copy(A.max).add(A.min).multiplyScalar(.5),V.copy(A.max).sub(A.min).multiplyScalar(.5),R.copy(V).multiply(new l.Vector3(...m)).add(q),S.set(...O).add(R),ie.current.position.copy(S),ee())}));const ae=u.useMemo((()=>({onDragStart:e=>{y.copy(te.current.matrix),w.copy(te.current.matrixWorld),t&&t(e),ee()},onDrag:e=>{g.copy(re.current.matrixWorld),v.copy(g).invert(),h.copy(w).premultiply(e),E.copy(h).premultiply(v),j.copy(y).invert(),b.copy(E).multiply(j),x&&te.current.matrix.copy(E),s&&s(E,b,h,e),ee()},onDragEnd:()=>{d&&d(),ee()},translation:ne,translationLimits:H,rotationLimits:I,axisColors:G,hoveredColor:J,opacity:Q,scale:z,lineWidth:k,fixed:F,depthTest:U,userData:Y,annotations:K,annotationsClass:N})),[t,s,d,ne,H,I,U,z,k,F,...G,J,Q,Y,x,K,N]),ce=new l.Vector3;return i.useFrame((e=>{if(F){const o=f(ie.current.getWorldPosition(ce),z,e.camera,e.size);var r,t,i;if(ie.current)(null==(r=ie.current)?void 0:r.scale.x)===o&&(null==(t=ie.current)?void 0:t.scale.y)===o&&(null==(i=ie.current)?void 0:i.scale.z)===o||(ie.current.scale.setScalar(o),e.invalidate())}})),u.useImperativeHandle(_,(()=>te.current),[]),u.useLayoutEffect((()=>{r&&r instanceof l.Matrix4&&(te.current.matrix=r)}),[r]),u.createElement(c.context.Provider,{value:ae},u.createElement("group",{ref:re},u.createElement("group",e({ref:te,matrix:r,matrixAutoUpdate:!1},$),u.createElement("group",{visible:X,ref:ie,position:O,rotation:T},!p&&B[0]&&u.createElement(o.AxisArrow,{axis:0,direction:C}),!p&&B[1]&&u.createElement(o.AxisArrow,{axis:1,direction:D}),!p&&B[2]&&u.createElement(o.AxisArrow,{axis:2,direction:P}),!W&&B[0]&&B[1]&&u.createElement(n.PlaneSlider,{axis:2,dir1:C,dir2:D}),!W&&B[0]&&B[2]&&u.createElement(n.PlaneSlider,{axis:1,dir1:P,dir2:C}),!W&&B[2]&&B[1]&&u.createElement(n.PlaneSlider,{axis:0,dir1:D,dir2:P}),!L&&B[0]&&B[1]&&u.createElement(a.AxisRotator,{axis:2,dir1:C,dir2:D}),!L&&B[0]&&B[2]&&u.createElement(a.AxisRotator,{axis:1,dir1:P,dir2:C}),!L&&B[2]&&B[1]&&u.createElement(a.AxisRotator,{axis:0,dir1:D,dir2:P})),u.createElement("group",{ref:oe},Z))))}));exports.PivotControls=W,exports.calculateScaleFactor=f;
