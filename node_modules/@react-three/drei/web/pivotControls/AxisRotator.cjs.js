"use strict";var e=require("react"),t=require("three"),r=require("@react-three/fiber"),n=require("../../core/Line.cjs.js"),o=require("../Html.cjs.js"),a=require("lodash.clamp"),i=require("./context.cjs.js");function c(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("@babel/runtime/helpers/extends"),require("three-stdlib"),require("react-dom/client");var s=c(e),l=c(t);const u=new l.Vector3,d=new l.Vector3,p=e=>180*e/Math.PI,m=e=>{let t=((e,t)=>{let r=Math.floor(e/t);return r=r<0?r+1:r,e-r*t})(e,2*Math.PI);return Math.abs(t)<1e-6?0:(t<0&&(t+=2*Math.PI),t)},h=new l.Matrix4,x=new l.Vector3,P=new l.Ray,f=new l.Vector3;exports.AxisRotator=({dir1:e,dir2:t,axis:c})=>{const{rotationLimits:M,annotations:b,annotationsClass:g,depthTest:y,scale:w,lineWidth:C,fixed:v,axisColors:I,hoveredColor:j,opacity:k,onDragStart:q,onDrag:R,onDragEnd:O,userData:V}=s.useContext(i.context),F=r.useThree((e=>e.controls)),D=s.useRef(null),E=s.useRef(null),W=s.useRef(0),z=s.useRef(0),T=s.useRef(null),[A,L]=s.useState(!1),S=s.useCallback((e=>{b&&(D.current.innerText=`${p(z.current).toFixed(0)}ยบ`,D.current.style.display="block"),e.stopPropagation();const t=e.point.clone(),r=(new l.Vector3).setFromMatrixPosition(E.current.matrixWorld),n=(new l.Vector3).setFromMatrixColumn(E.current.matrixWorld,0).normalize(),o=(new l.Vector3).setFromMatrixColumn(E.current.matrixWorld,1).normalize(),a=(new l.Vector3).setFromMatrixColumn(E.current.matrixWorld,2).normalize(),i=(new l.Plane).setFromNormalAndCoplanarPoint(a,r);T.current={clickPoint:t,origin:r,e1:n,e2:o,normal:a,plane:i},q({component:"Rotator",axis:c,origin:r,directions:[n,o,a]}),F&&(F.enabled=!1),e.target.setPointerCapture(e.pointerId)}),[b,F,q,c]),H=s.useCallback((e=>{if(e.stopPropagation(),A||L(!0),T.current){const{clickPoint:t,origin:r,e1:n,e2:o,normal:i,plane:s}=T.current,[l,g]=(null==M?void 0:M[c])||[void 0,void 0];P.copy(e.ray),P.intersectPlane(s,f),P.direction.negate(),P.intersectPlane(s,f);let y=((e,t,r,n,o)=>{u.copy(e).sub(r),d.copy(t).sub(r);const a=n.dot(n),i=o.dot(o),c=u.dot(n)/a,s=u.dot(o)/i,l=d.dot(n)/a,p=d.dot(o)/i,m=Math.atan2(s,c);return Math.atan2(p,l)-m})(t,f,r,n,o),w=p(y);e.shiftKey&&(w=10*Math.round(w/10),y=(e=>e*Math.PI/180)(w)),void 0!==l&&void 0!==g&&g-l<2*Math.PI?(y=m(y),y=y>Math.PI?y-2*Math.PI:y,y=a(y,l-W.current,g-W.current),z.current=W.current+y):(z.current=m(W.current+y),z.current=z.current>Math.PI?z.current-2*Math.PI:z.current),b&&(w=p(z.current),D.current.innerText=`${w.toFixed(0)}ยบ`),h.makeRotationAxis(i,y),x.copy(r).applyMatrix4(h).sub(r).negate(),h.setPosition(x),R(h)}}),[b,R,A,M,c]),N=s.useCallback((e=>{b&&(D.current.style.display="none"),e.stopPropagation(),W.current=z.current,T.current=null,O(),F&&(F.enabled=!0),e.target.releasePointerCapture(e.pointerId)}),[b,F,O]),U=s.useCallback((e=>{e.stopPropagation(),L(!1)}),[]),$=s.useMemo((()=>{const r=e.clone().normalize(),n=t.clone().normalize();return(new l.Matrix4).makeBasis(r,n,r.clone().cross(n))}),[e,t]),B=v?.65:.65*w,K=s.useMemo((()=>{const e=[];for(let t=0;t<=32;t++){const r=t*(Math.PI/2)/32;e.push(new l.Vector3(Math.cos(r)*B,Math.sin(r)*B,0))}return e}),[B]);return s.createElement("group",{ref:E,onPointerDown:S,onPointerMove:H,onPointerUp:N,onPointerOut:U,matrix:$,matrixAutoUpdate:!1},b&&s.createElement(o.Html,{position:[B,B,0]},s.createElement("div",{style:{display:"none",background:"#151520",color:"white",padding:"6px 8px",borderRadius:7,whiteSpace:"nowrap"},className:g,ref:D})),s.createElement(n.Line,{points:K,lineWidth:4*C,visible:!1,userData:V}),s.createElement(n.Line,{transparent:!0,raycast:()=>null,depthTest:y,points:K,lineWidth:C,color:A?j:I[c],opacity:k,polygonOffset:!0,polygonOffsetFactor:-10,fog:!1}))};
