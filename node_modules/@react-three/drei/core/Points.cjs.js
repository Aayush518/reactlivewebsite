"use strict";var e=require("@babel/runtime/helpers/extends"),t=require("three"),r=require("react"),n=require("@react-three/fiber"),a=require("react-merge-refs");function i(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var n=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,n.get?n:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}var s=i(t),o=i(r);const c=new s.Matrix4,u=new s.Ray,l=new s.Sphere,f=new s.Vector3;class d extends s.Group{constructor(){super(),this.size=0,this.color=new s.Color("white"),this.instance={current:void 0},this.instanceKey={current:void 0}}get geometry(){var e;return null==(e=this.instance.current)?void 0:e.geometry}raycast(e,t){var r,n;const a=this.instance.current;if(!a||!a.geometry)return;const i=a.userData.instances.indexOf(this.instanceKey);if(-1===i||i>a.geometry.drawRange.count)return;const o=null!==(r=null==(n=e.params.Points)?void 0:n.threshold)&&void 0!==r?r:1;if(l.set(this.getWorldPosition(f),o),!1===e.ray.intersectsSphere(l))return;c.copy(a.matrixWorld).invert(),u.copy(e.ray).applyMatrix4(c);const d=o/((this.scale.x+this.scale.y+this.scale.z)/3),m=d*d,y=u.distanceSqToPoint(this.position);if(y<m){const r=new s.Vector3;u.closestPointToPoint(this.position,r),r.applyMatrix4(this.matrixWorld);const n=e.ray.origin.distanceTo(r);if(n<e.near||n>e.far)return;t.push({distance:n,distanceToRay:Math.sqrt(y),point:r,index:i,face:null,object:this})}}}let m,y;const p=o.createContext(null),h=new s.Matrix4,g=new s.Vector3,b=o.forwardRef((({children:t,range:r,limit:i=1e3,...c},u)=>{const l=o.useRef(null),[f,d]=o.useState([]),[[b,x,w]]=o.useState((()=>[new Float32Array(3*i),Float32Array.from({length:3*i},(()=>1)),Float32Array.from({length:i},(()=>1))]));o.useEffect((()=>{l.current.geometry.attributes.position.needsUpdate=!0})),n.useFrame((()=>{for(l.current.updateMatrix(),l.current.updateMatrixWorld(),h.copy(l.current.matrixWorld).invert(),l.current.geometry.drawRange.count=Math.min(i,void 0!==r?r:i,f.length),m=0;m<f.length;m++)y=f[m].current,y.getWorldPosition(g).applyMatrix4(h),g.toArray(b,3*m),l.current.geometry.attributes.position.needsUpdate=!0,y.matrixWorldNeedsUpdate=!0,y.color.toArray(x,3*m),l.current.geometry.attributes.color.needsUpdate=!0,w.set([y.size],m),l.current.geometry.attributes.size.needsUpdate=!0}));const P=o.useMemo((()=>({getParent:()=>l,subscribe:e=>(d((t=>[...t,e])),()=>d((t=>t.filter((t=>t.current!==e.current)))))})),[]);return o.createElement("points",e({userData:{instances:f},matrixAutoUpdate:!1,ref:a([u,l]),raycast:()=>null},c),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:b.length/3,array:b,itemSize:3,usage:s.DynamicDrawUsage}),o.createElement("bufferAttribute",{attach:"attributes-color",count:x.length/3,array:x,itemSize:3,usage:s.DynamicDrawUsage}),o.createElement("bufferAttribute",{attach:"attributes-size",count:w.length,array:w,itemSize:1,usage:s.DynamicDrawUsage})),o.createElement(p.Provider,{value:P},t))})),x=o.forwardRef((({children:t,...r},i)=>{o.useMemo((()=>n.extend({PositionPoint:d})),[]);const s=o.useRef(),{subscribe:c,getParent:u}=o.useContext(p);return o.useLayoutEffect((()=>c(s)),[]),o.createElement("positionPoint",e({instance:u(),instanceKey:s,ref:a([i,s])},r),t)})),w=o.forwardRef((({children:t,positions:r,colors:i,sizes:c,stride:u=3,...l},f)=>{const d=o.useRef(null);return n.useFrame((()=>{const e=d.current.geometry.attributes;e.position.needsUpdate=!0,i&&(e.color.needsUpdate=!0),c&&(e.size.needsUpdate=!0)})),o.createElement("points",e({ref:a([f,d])},l),o.createElement("bufferGeometry",null,o.createElement("bufferAttribute",{attach:"attributes-position",count:r.length/u,array:r,itemSize:u,usage:s.DynamicDrawUsage}),i&&o.createElement("bufferAttribute",{attach:"attributes-color",count:i.length/u,array:i,itemSize:3,usage:s.DynamicDrawUsage}),c&&o.createElement("bufferAttribute",{attach:"attributes-size",count:c.length/u,array:c,itemSize:1,usage:s.DynamicDrawUsage})),t)})),P=o.forwardRef(((t,r)=>t.positions instanceof Float32Array?o.createElement(w,e({},t,{ref:r})):o.createElement(b,e({},t,{ref:r}))));exports.Point=x,exports.Points=P,exports.PointsBuffer=w,exports.PositionPoint=d;
