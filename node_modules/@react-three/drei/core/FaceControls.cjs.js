"use strict";var e=require("@babel/runtime/helpers/extends"),t=require("three"),r=require("react"),a=require("@react-three/fiber"),n=require("maath"),o=require("suspend-react"),c=require("./useVideoTexture.cjs.js"),s=require("./Facemesh.cjs.js"),u=require("./FaceLandmarker.cjs.js");function i(e){var t=Object.create(null);return e&&Object.keys(e).forEach((function(r){if("default"!==r){var a=Object.getOwnPropertyDescriptor(e,r);Object.defineProperty(t,r,a.get?a:{enumerable:!0,get:function(){return e[r]}})}})),t.default=e,Object.freeze(t)}require("./Line.cjs.js"),require("three-stdlib"),require("@mediapipe/tasks-vision");var l=i(t),d=i(r);function f(e,t){return e.clone().add(t).multiplyScalar(.5)}function p(e,t,r){const a=e.localToWorld(t);return r.worldToLocal(a)}const m=r.createContext({}),v=r.forwardRef((({camera:t,autostart:o=!0,webcam:c=!0,webcamVideoTextureSrc:i,manualUpdate:v=!1,manualDetect:b=!1,onVideoFrame:y,smoothTime:w=.25,offset:T=!0,offsetScalar:x=80,eyes:E=!1,eyesAsOrigin:k=!0,depth:V=.15,debug:g=!1,facemesh:j,makeDefault:F},R)=>{var S,q;const C=a.useThree((e=>e.scene)),O=a.useThree((e=>e.camera)),D=a.useThree((e=>e.set)),A=a.useThree((e=>e.get)),M=t||O,L=r.useRef(null),P=r.useRef(null),[I]=r.useState((()=>new l.Object3D)),[B]=r.useState((()=>new l.Vector3)),[H]=r.useState((()=>new l.Vector3)),[W]=r.useState((()=>new l.Vector3)),[z]=r.useState((()=>new l.Vector3)),U=r.useCallback((()=>{I.parent=M.parent;const e=P.current;if(e){const{outerRef:t,eyeRightRef:r,eyeLeftRef:a}=e;if(r.current&&a.current){const{irisDirRef:e}=r.current,{irisDirRef:n}=a.current;e.current&&n.current&&t.current&&(B.copy(p(e.current,new l.Vector3(0,0,0),t.current)),H.copy(p(n.current,new l.Vector3(0,0,0),t.current)),I.position.copy(p(t.current,f(B,H),M.parent||C)),W.copy(p(e.current,new l.Vector3(0,0,1),t.current)),z.copy(p(n.current,new l.Vector3(0,0,1),t.current)),I.lookAt(t.current.localToWorld(f(W,z))))}else t.current&&(I.position.copy(p(t.current,new l.Vector3(0,0,0),M.parent||C)),I.lookAt(t.current.localToWorld(new l.Vector3(0,0,1))))}return I}),[M,H,z,B,W,C,I]),[G]=r.useState((()=>new l.Object3D)),J=r.useCallback((function(e,t){if(M){var r;if(null!==(r=t)&&void 0!==r||(t=U()),w>0){const r=1e-9;n.easing.damp3(G.position,t.position,w,e,void 0,void 0,r),n.easing.dampE(G.rotation,t.rotation,w,e,void 0,void 0,r)}else G.position.copy(t.position),G.rotation.copy(t.rotation);M.position.copy(G.position),M.rotation.copy(G.rotation)}}),[M,U,w,G.position,G.rotation]),[K,N]=r.useState(),Q=u.useFaceLandmarker(),X=r.useCallback(((e,t)=>{const r=null==Q?void 0:Q.detectForVideo(e,t);N(r)}),[Q]);a.useFrame(((e,t)=>{v||J(t)}));const Y=r.useMemo((()=>Object.assign(Object.create(l.EventDispatcher.prototype),{detect:X,computeTarget:U,update:J,facemeshApiRef:P,webcamApiRef:L,play:()=>{var e,t;null==(e=L.current)||null==(t=e.videoTextureApiRef.current)||t.texture.source.data.play()},pause:()=>{var e,t;null==(e=L.current)||null==(t=e.videoTextureApiRef.current)||t.texture.source.data.pause()}})),[X,U,J]);r.useImperativeHandle(R,(()=>Y),[Y]),r.useEffect((()=>{const e=e=>{b||X(e.texture.source.data,e.time),y&&y(e)};return Y.addEventListener("videoFrame",e),()=>{Y.removeEventListener("videoFrame",e)}}),[Y,X,Q,b,y]),r.useEffect((()=>{if(F){const e=A().controls;return D({controls:Y}),()=>D({controls:e})}}),[F,Y,A,D]);const Z=null==K?void 0:K.faceLandmarks[0],$=null==K||null==(S=K.facialTransformationMatrixes)?void 0:S[0],_=null==K||null==(q=K.faceBlendshapes)?void 0:q[0];return d.createElement(m.Provider,{value:Y},c&&d.createElement(r.Suspense,{fallback:null},d.createElement(h,{ref:L,autostart:o,videoTextureSrc:i})),d.createElement(s.Facemesh,e({ref:P},j,{points:Z,depth:V,facialTransformationMatrix:$,faceBlendshapes:_,eyes:E,eyesAsOrigin:k,offset:T,offsetScalar:x,debug:g,"rotation-z":Math.PI,visible:g}),d.createElement("meshBasicMaterial",{side:l.DoubleSide})))})),b=()=>r.useContext(m),h=r.forwardRef((({videoTextureSrc:e,autostart:t=!0},a)=>{const n=r.useRef(null),c=b(),s=o.suspend((async()=>e?Promise.resolve(null):await navigator.mediaDevices.getUserMedia({audio:!1,video:{facingMode:"user"}})),[e]);r.useEffect((()=>(c.dispatchEvent({type:"stream",stream:s}),()=>{null==s||s.getTracks().forEach((e=>e.stop())),o.clear([e])})),[s,c,e]);const u=r.useMemo((()=>({videoTextureApiRef:n})),[]);return r.useImperativeHandle(a,(()=>u),[u]),d.createElement(r.Suspense,{fallback:null},d.createElement(y,{ref:n,src:e||s,start:t}))})),y=r.forwardRef((({src:e,start:t},a)=>{const n=c.useVideoTexture(e,{start:t}),o=n.source.data,s=b(),u=r.useCallback((e=>{s.dispatchEvent({type:"videoFrame",texture:n,time:e})}),[n,s]);w(o,u);const i=r.useMemo((()=>({texture:n})),[n]);return r.useImperativeHandle(a,(()=>i),[i]),d.createElement(d.Fragment,null)})),w=(e,t)=>{r.useEffect((()=>{if(!e||!e.requestVideoFrameCallback)return;let r;return e.requestVideoFrameCallback((function a(...n){t(...n),r=e.requestVideoFrameCallback(a)})),()=>e.cancelVideoFrameCallback(r)}),[e,t])};exports.FaceControls=v,exports.useFaceControls=b;
