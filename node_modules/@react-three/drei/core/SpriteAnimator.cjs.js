"use strict";var e=require("react"),r=require("@react-three/fiber"),t=require("three");function n(e){var r=Object.create(null);return e&&Object.keys(e).forEach((function(t){if("default"!==t){var n=Object.getOwnPropertyDescriptor(e,t);Object.defineProperty(r,t,n.get?n:{enumerable:!0,get:function(){return e[t]}})}})),r.default=e,Object.freeze(r)}var a=n(e),u=n(t);exports.SpriteAnimator=({startFrame:e,endFrame:t,fps:n,frameName:c,textureDataURL:s,textureImageURL:f,loop:o,numberOfFrames:m,autoPlay:i,animationNames:l,onStart:p,onEnd:h,onLoopEnd:w,onFrame:y,play:S,pause:d,flipX:g,alphaTest:x,children:z,...b},F)=>{r.useThree((e=>e.viewport));const A=a.useRef(null),[E,R]=a.useState(!1),O=a.useRef(),j=a.useRef(),L=a.useRef(window.performance.now()),v=a.useRef(),T=a.useRef(e||0),N=a.useRef(c||""),P=1e3/(n||30),[k,q]=a.useState(new u.Texture),M=a.useRef(0),[C,D]=a.useState([1,1,1]),I=g?-1:1;const U=(e,r)=>{const t=r/e;return j.current.scale.set(1,t,1),[1,t,1]};a.useEffect((()=>{if(s&&f)!function(e,r,t){const n=new u.TextureLoader,a=fetch(e).then((e=>e.json())),c=new Promise((e=>{n.load(r,e)}));Promise.all([a,c]).then((e=>{t(e[0],e[1])}))}(s,f,W);else if(f){const e=new u.TextureLoader;new Promise((r=>{e.load(f,r)})).then((e=>{W(null,e)}))}}),[]),a.useLayoutEffect((()=>{B()}),[k,g]),a.useEffect((()=>{}),[d]),a.useEffect((()=>{N.current!==c&&c&&(T.current=0,N.current=c)}),[c]);const W=(e,r)=>{if(null===e){if(r&&m){const e=r.image.width,t=r.image.height,n=e/m,a=t;if(v.current=r,M.current=m,A.current={frames:[],meta:{version:"1.0",size:{w:e,h:t},scale:"1"}},parseInt(n.toString(),10)===n)for(let e=0;e<m;e++)A.current.frames.push({frame:{x:e*n,y:0,w:n,h:a},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:n,h:a},sourceSize:{w:n,h:t}})}}else if(r){A.current=e,A.current.frames=Array.isArray(e.frames)?e.frames:X(),M.current=Array.isArray(e.frames)?e.frames.length:Object.keys(e.frames).length,v.current=r;const{w:t,h:n}=G(e.frames).sourceSize,a=U(t,n);D(a),O.current&&(O.current.map=r)}r.premultiplyAlpha=!1,q(r)},X=()=>{const e={},r=A.current,t=l;if(t)for(let n=0;n<t.length;n++){e[t[n]]=[];for(let a in r.frames){const u=r.frames[a],c=u.frame,s=c.x,f=c.y,o=c.w,m=c.h,i=u.sourceSize.w,l=u.sourceSize.h;"string"==typeof a&&-1!==a.toLowerCase().indexOf(t[n].toLowerCase())&&e[t[n]].push({x:s,y:f,w:o,h:m,frame:c,sourceSize:{w:i,h:l}})}}return e},B=()=>{if(!A.current)return;const{meta:{size:e},frames:r}=A.current,{w:t,h:n}=Array.isArray(r)?r[0].sourceSize:c&&r[c]?r[c][0].sourceSize:{w:0,h:0};O.current.map.wrapS=O.current.map.wrapT=u.RepeatWrapping,O.current.map.center.set(0,0),O.current.map.repeat.set(1*I/(e.w/t),1/(e.h/n));const a=1/((e.h-1)/n);O.current.map.offset.x=0,O.current.map.offset.y=1-a,R(!0),p&&p({currentFrameName:c,currentFrame:T.current})};r.useFrame(((r,n)=>{var a,u;null!=(a=A.current)&&a.frames&&null!=(u=O.current)&&u.map&&(d||(i||S)&&((()=>{const r=window.performance.now(),n=r-L.current,{meta:{size:a},frames:u}=A.current,{w:s,h:f}=G(u).sourceSize,m=Array.isArray(u)?u:c?u[c]:[];let i=0,l=0;const p=t||m.length-1;if(T.current>p&&(T.current=o&&null!=e?e:0,o?null==w||w({currentFrameName:c,currentFrame:T.current}):null==h||h({currentFrameName:c,currentFrame:T.current}),!o))return;if(n<=P)return;L.current=r-n%P,U(s,f);const y=(a.w-1)/s,S=(a.h-1)/f,{frame:{x:d,y:g},sourceSize:{w:x,h:z}}=m[T.current],b=1/y,F=1/S;i=I>0?b*(d/x):b*(d/x)-O.current.map.repeat.x,l=Math.abs(1-F)-F*(g/z),O.current.map.offset.x=i,O.current.map.offset.y=l,T.current+=1})(),y&&y({currentFrameName:N.current,currentFrame:T.current})))}));const G=e=>{if(Array.isArray(e))return e[0];if("object"==typeof e&&null!==e){return e[Object.keys(e)[0]][0]}return{w:0,h:0}};return a.createElement("group",b,a.createElement(a.Suspense,{fallback:null},a.createElement("sprite",{ref:j,scale:C},a.createElement("spriteMaterial",{toneMapped:!1,ref:O,map:k,transparent:!0,alphaTest:null!=x?x:0}))),z)};
